let boxes=[];let boxSize=60;let roadCount=2;let road1X=0;let road1Z=0;let road1L=2e3;let road1W=50;let road2X=0;let road2Z=0;let road2L=2e3;let road2W=50;let roadX=[];let roadZ=[];let roadL=[];let roadW=[];let roadGap=200;let VroadX=[];let VroadZ=[];let VroadL=[];let VroadW=[];let timer=0;let moveX=0;let moveY=0;let moveZ=0;let move=true;let totalCount=800;let mic;let fft;let fft2;let amplitudeRaw;let pulseFilter=[];let pulseFilterSize=4;let pulseFilterSum;let pulseFilterAverage;let amplitudeStore=[];let soundSpectrum;let inputSmoothness=.95;let integerSoundArrayDivide;let audioPowerVHF=0;let audioPowerBASS=0;let slowDown=0;let carSpeedFactor=.1;function setup(){mic=new p5.AudioIn;fft2=new p5.FFT(0,1024);fft2.setInput(mic);mic.start();integerSoundArrayDivide=20;createCanvas(windowWidth,windowHeight,WEBGL);perspective(PI/3,width/height,1,5e4);frameRate(60);background(20);for(let i=0;i<roadCount;i++){roadX.push(width/2+roadGap*int(random(-10,10)));roadZ.push(roadGap*int(random(-2,2)));roadL.push(random(6e3,8e3));roadW.push(50);VroadX.push(roadGap*int(random(-2,2)));VroadZ.push(width/2+roadGap*int(random(-10,10)));VroadL.push(50);VroadW.push(random(6e3,8e3))}let tempXpos;let tempYpos;let tempZpos;let tempXstore;let tempZstore;for(let i=0;i<totalCount;i++){tempYpos=height*.6;tempXpos=boxSize*floor(random(-20,20));tempZpos=boxSize*floor(random(-20,20));let tempBoxArray=boxes;for(let i=0;i<tempBoxArray.length;i++){if(tempXpos==tempBoxArray[i].x&&tempZpos==tempBoxArray[i].z){tempXpos=boxSize*floor(random(-30,30));tempZpos=boxSize*floor(random(-30,30))}}for(let i=0;i<roadX.length;i++){if(tempXpos>roadX[i]-roadW[i]*3&&tempXpos<roadX[i]+roadW[i]*3){tempXpos=boxSize*random([random(-40,-30),random(30,40)])}if(tempZpos>VroadZ[i]-VroadL[i]*2&&tempZpos<VroadZ[i]+VroadL[i]*2){tempZpos=boxSize*random([random(-40,-30),random(30,40)])}}boxes.push(new DBox(tempXpos,tempYpos,tempZpos,boxSize));tempXstore=tempXpos;tempZstore=tempZpos}for(let i=0;i<roadX.length;i++){if(this.x>roadX[i]-roadW[i]*3&&this.x<roadX[i]+roadW[i]*3){this.x+=this.size*int(random(-5,5));this.xStore=this.x}if(this.z>VroadZ[i]-VroadL[i]*2&&this.z<VroadZ[i]+VroadL[i]*2){this.z+=this.size*int(random(-5,5));this.zStore=this.z}}}function draw(){getAudioContext().resume();amplitudeRaw=mic.getLevel(inputSmoothness);pulseFilter.push(amplitudeRaw);if(pulseFilter.length>pulseFilterSize){pulseFilter.splice(0,1)}pulseFilterSum=0;for(let i=0;i<pulseFilter.length;i++){pulseFilterSum+=pulseFilter[i]}pulseFilterAverage=pulseFilterSum/pulseFilter.length;amplitudeStore.push(pulseFilterAverage);if(amplitudeStore.length>boxes.length/integerSoundArrayDivide){amplitudeStore.splice(0,1)}carSpeedFactor=.8;slowDown+=1;if(slowDown%5==0){fft2.analyze();audioPowerVHF=fft2.getEnergy(12e3,2e4);audioPowerBASS=fft2.getEnergy(1,3e3);audioInteractive(audioPowerBASS,audioPowerVHF)}background(20,40,60);rotateX(radians(-90));translate(0,1e3,0);let xRotateFactor=1;let yRotateFactor=1;rotateX(radians(map(mouseY,0,height,0*xRotateFactor,96*xRotateFactor)));rotateY(radians(map(mouseX,0,width,-180*yRotateFactor,135*yRotateFactor)));if(keyCode===RIGHT_ARROW&&move==true){moveX-=2;if(moveX<-width*2){move=false}}if(keyCode===LEFT_ARROW&&move==true){moveX+=2;if(moveX>width*2){move=false}}if(keyCode===DOWN_ARROW&&move==true){moveZ-=2;if(moveZ<-width*2){move=false}}else if(keyCode===UP_ARROW&&move==true){moveZ+=2;if(moveZ>width*2){move=false}}translate(moveX,moveY,moveZ);push();translate(0,height*.6,0);fill(20);box(width*50,0,width*50);pop();for(let i=0;i<roadX.length;i++){push();translate(roadX[i],height*.6,roadZ[i]);push();translate(0,-height*.2,0);for(let v=0;v<20;v++){car(0-roadW[i]/2,30*sin(carSpeedFactor*.005*millis()),0+roadL[i]/2*sin(carSpeedFactor*5e-4*millis()+v),color(240,20,180));car(0+roadW[i]/2,30*sin(carSpeedFactor*.005*millis()),0+roadL[i]/2*cos(carSpeedFactor*5e-4*millis()+v+HALF_PI),color(20,80,100))}pop();fill(20);stroke(200);box(roadW[i]*2,5,roadL[i]);pop()}for(let i=0;i<roadX.length;i++){push();translate(VroadX[i],height*.6,VroadZ[i]);push();translate(0,-height*.3,0);for(let v=0;v<20;v++){carV(0+VroadW[i]/2*sin(carSpeedFactor*5e-4*millis()+v),30*sin(carSpeedFactor*.005*millis()),0-VroadL[i]/2,color(240,20,180));carV(0+VroadW[i]/2*cos(carSpeedFactor*5e-4*millis()+v+HALF_PI),30*cos(carSpeedFactor*.005*millis()),0+VroadL[i]/2,color(20,80,100))}pop();fill(20);stroke(200);box(VroadW[i],5,VroadL[i]*2);pop()}let newHeightFactor=1;let currentHeight;let newDynaTimer;for(let i=0;i<amplitudeStore.length;i+=1){index=i*integerSoundArrayDivide;for(let v=0;v<integerSoundArrayDivide;v++){let soundMapped=amplitudeStore[i]*1e3;let originalHeight=.8+.1*sin(5e-4*millis());if(soundMapped<14){if(newHeightFactor>originalHeight){newHeightFactor-=(newHeightFactor-originalHeight)*.005}else{newHeightFactor=originalHeight}}else if(soundMapped>=14&&soundMapped<=30){newHeightFactor=map(soundMapped,0,30,originalHeight,1.2)}else if(soundMapped>=30&&soundMapped<70){newHeightFactor=map(soundMapped,30,120,1.2,1.5)}else if(soundMapped>=70&&soundMapped<140){newHeightFactor=map(soundMapped,120,200,1.5,1.6)}else if(soundMapped>=140){newHeightFactor=map(soundMapped,200,500,1.6,1.65)}if(soundMapped>=250){newDynaTimer=random(1,2);boxes[index+v].dynaTimer=newDynaTimer}currentHeight=newHeightFactor;boxes[index+v].hFactor=newHeightFactor;boxes[index+v].show()}}}function keyPressed(){if(keyCode===LEFT_ARROW){move=true}if(keyCode===RIGHT_ARROW){move=true}if(keyCode===UP_ARROW){move=true}else if(keyCode===DOWN_ARROW){move=true}}function mousePressed(){danceEvent()}function beatEvent(){for(let i=0;i<boxes.length;i++){boxes[i].dynaTimer=random(2,8)}}function danceEvent(){for(let i=0;i<boxes.length;i++){boxes[i].moveTimer=random(10,20)}}function car(x,y,z,colorCar){push();translate(x,y,z);fill(colorCar);box(10,15,20);pop()}function carV(x,y,z,colorCar){push();translate(x,y,z);fill(colorCar);box(20,15,10);pop()}function DBox(x,y,z,size){this.x=x;this.y=y;this.z=z;this.size=size*.8;this.sizeStore=size;this.w=this.size;this.h=random([random(.8,1)*this.size,random(2,5)*this.size,random(.8,7)*this.size,random(0,12)*this.size]);push();colorMode(HSB,360,100,100,100);this.randomColor1=random(20,40);this.randomColor1_2=random(10,40);this.randomColor2=random([color(random(170,225),random(10,80),random(80,100)),color(303,79,100),color(290,54,89),color(201,71,81),color(201,71,81),color(244,64,85),color(208,98,84),color(254,63,100)]);this.randomColor3=random([color(random(170,225),random(10,80),random(80,100)),color(303,79,100),color(290,54,89),color(201,71,81),color(201,71,81),color(244,64,85),color(208,98,84),color(254,63,100)]);this.randomColor4=0;this.colorBox=random([this.randomColor1,this.randomColor2,this.randomColor4,this.randomColor4]);if(this.colorBox==this.randomColor2){this.colorStroke=random(10,50);this.strokeWeight=random([1,2])}else{this.colorStroke=random([this.randomColor2,this.randomColor2,this.randomColor2,this.randomColor1_2]);this.strokeWeight=random([0,1,3,5])}this.colorStrokeStore=this.colorStroke;this.colorBoxStore=this.colorBox;pop();this.moveTimer=0;this.speedFactor=1;this.model=random([1,1,1,1,1,1,2,3,3,3,3,4,4,5,5,5]);this.cylinderDetail=floor(this.h*1.2/this.size*.618);this.coneDetail=random([3,3,4,4,4,4,4,4,4,4,4,4,5]);this.ellipsoidDetailY=random([4,4,4,5,6,7,8,9]);this.cement=color(random(40,120));this.grass=color(20,180,100);this.tile=this.cement;this.tileWidth=this.size*random(1,2);this.tileLength=this.size*random(1,2);this.tileHeight=random(2,4);this.move=false;this.xStore=this.x;this.zStore=this.z;this.hStore=this.h;this.sizeStore=this.size;this.hFactor=1;this.dynamicBeatsColor=false;this.dynaTimer=0;this.show=function(){push();translate(this.x,this.y,this.z);if(this.moveTimer>0){this.speedFactor=map(this.moveTimer,100,0,1,0);this.tileWidth=this.size*random(1,2);this.tileLength=this.size*random(1,2);this.x+=random(-15,15);this.z+=random(-15,15);this.size*=random(.8,1.2);this.colorStroke=random(20,255);this.moveTimer-=1;this.move=true}else{this.x=this.xStore;this.z=this.zStore;this.size=this.sizeStore;this.colorStroke=this.colorStrokeStore;this.move=false}this.h=this.hStore*this.hFactor;if(this.dynaTimer>0){this.flashcolor=random(20,255);this.colorStroke=color(100,this.flashcolor,250);this.colorBox=random(0,40);this.dynaTimer-=1}else{this.colorStroke=this.colorStrokeStore;this.colorBox=this.colorBoxStore}strokeWeight(this.strokeWeight);stroke(this.colorStroke);fill(this.colorBox);translate(0,-this.h/2,0);smooth(3);if(this.model==1){box(this.size*.8,this.h,this.w*.8);push();translate(0,this.h/2,0);fill(this.tile);noStroke();box(this.tileWidth,this.tileHeight,this.tileLength);pop()}else if(this.model==2){rotateY(radians(45));rotateX(radians(-180));cone(this.size*.5,this.h,4,1);push();fill(this.tile);translate(0,-this.h/2,0);rotateY(radians(45));noStroke();box(this.tileWidth,this.tileHeight,this.tileLength);pop()}else if(this.model==3){rotateY(radians(45));cylinder(this.size*.618,this.h*1.2,this.coneDetail,this.cylinderDetail);push();fill(this.tile);translate(0,this.h/2,0);rotateY(radians(45));noStroke();box(this.tileWidth,this.tileHeight,this.tileLength);pop()}else if(this.model==4){ellipsoid(this.size*.618,this.h*1.5,this.size*.618,this.coneDetail,this.ellipsoidDetailY);push();fill(this.tile);translate(0,this.h/2,0);noStroke();box(this.tileWidth,this.tileHeight,this.tileLength);pop()}else if(this.model==5){push();fill(this.tile);translate(0,this.h/2,0);noStroke();box(this.tileWidth,this.tileHeight,this.tileLength);pop()}pop();this.dynamicBeatsColor=false}}let dynaMic=[];let dynaMicBASS=[];let counter=1;function audioInteractive(lowPitchPower,highPitchPower){let sum=0;let average;let sumBASS=0;let averageBASS;dynaMic.push(highPitchPower);dynaMicBASS.push(lowPitchPower);if(dynaMic.length>5){dynaMic.splice(0,1)}if(dynaMicBASS.length>5){dynaMicBASS.splice(0,1)}for(let i=0;i<dynaMic.length-1;i++){sum+=dynaMic[i]}average=sum/(dynaMic.length-1);for(let i=0;i<dynaMicBASS.length-1;i++){sumBASS+=dynaMicBASS[i]}averageBASS=sumBASS/(dynaMicBASS.length-1);if(dynaMic[dynaMic.length-1]/average>1.5){}if(dynaMic[dynaMic.length-1]/dynaMic[0]>1.2){}if(lowPitchPower/averageBASS>1.015){}if(counter==1){if(dynaMic[dynaMic.length-1]/average>1.5&&dynaMic[dynaMic.length-1]/dynaMic[0]>1.2&&lowPitchPower/averageBASS>1.015){beatEvent()}}}